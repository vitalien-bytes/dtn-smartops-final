<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>{{ board.title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="light">
<header class="topbar">
  <div class="brand">
    <img src="/static/logo.png" alt="logo" class="logo">
    <h1><span class="brand-black">DTN</span> <span class="brand-orange">SmartOps</span></h1>
  </div>

  <form action="/logout" method="get">
    <button type="submit" class="btn-outline">Déconnexion</button>
  </form>
</header>

<section class="toolbar">
  <form action="/add_column" method="post" class="inline">
    <input type="text" name="name" placeholder="Nom de la colonne…" required>
    <button class="btn">Ajouter colonne</button>
  </form>
</section>

<main class="board">
  {% for col in columns %}
  <section class="column">
    <div class="column-header">
      <h2>{{ col.title }}</h2>

      <div class="menu">
        <button class="menu-btn" aria-label="menu">⋮</button>
        <div class="menu-list">
          <form action="/rename_column/{{ col.id }}" method="post">
            <input type="text" name="new_title" placeholder="Nouveau nom" required>
            <button class="menu-item" type="submit">Renommer</button>
          </form>
          <form action="/delete_column/{{ col.id }}" method="post"
                onsubmit="return confirm('Supprimer la colonne et ses cartes ?');">
            <button class="menu-item danger" type="submit">Supprimer</button>
          </form>
        </div>
      </div>
    </div>

    <div class="cards" data-column-id="{{ col.id }}">
      {% for card in cards_by_col[col.id] %}
      <article class="card" data-card-id="{{ card.id }}" draggable="true">
        <p>{{ card.text }}</p>
        <form action="/delete_card/{{ card.id }}" method="post" class="inline">
          <button class="small danger" title="Supprimer">✕</button>
        </form>
      </article>
      {% endfor %}
    </div>

    <form action="/add_card/{{ col.id }}" method="post" class="add-card">
      <input type="text" name="text" placeholder="Nouvelle tâche…" required>
      <button class="small">+</button>
    </form>
  </section>
  {% endfor %}
</main>

<script>
  // --- menus des colonnes ---
  document.querySelectorAll('.menu-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = btn.parentElement.querySelector('.menu-list');
      document.querySelectorAll('.menu-list').forEach(m => m !== menu && m.classList.remove('open'));
      menu.classList.toggle('open');
    });
  });
  document.addEventListener('click', () => {
    document.querySelectorAll('.menu-list').forEach(m => m.classList.remove('open'));
  });

  // --- Drag & Drop des cartes ---
  const columns = document.querySelectorAll('.cards');
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', card.dataset.cardId);
      e.dataTransfer.effectAllowed = 'move';
    });
  });
  columns.forEach(col => {
    col.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
    col.addEventListener('drop', async e => {
      e.preventDefault();
      const cardId = e.dataTransfer.getData('text/plain');
      const newColId = col.dataset.columnId;
      const res = await fetch(`/move_card/${cardId}/${newColId}`, { method: 'POST' });
      if (res.ok) location.reload();
    });
  });
</script>
</body>
</html>
