<script>
  const board = document.getElementById("board");
  const modal = document.getElementById("taskModal");
  const form = document.getElementById("taskForm");
  const addBtn = document.getElementById("addTaskBtn");

  const columnTypes = [
    "Électricité",
    "Fibre",
    "Cuivre",
    "PV / Solaire",
    "GC / Viabilisation",
    "Autre"
  ];

  let tasks = [];
  let draggedTaskId = null;

  function openModal() { modal.showModal(); }
  function closeModal() { modal.close(); }

  addBtn.addEventListener("click", openModal);

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const newTask = {
      id: Date.now(),
      nom: form.nom.value,
      prenom: form.prenom.value,
      adresse: form.adresse.value,
      date_rdv: form.date_rdv.value,
      job_type: form.job_type.value
    };
    tasks.push(newTask);
    renderBoard();
    closeModal();
    form.reset();
  });

  function renderBoard() {
    board.innerHTML = '';

    columnTypes.forEach(type => {
      const col = document.createElement("div");
      col.className = "column";
      col.dataset.type = type;

      col.addEventListener("dragover", handleDragOver);
      col.addEventListener("dragleave", handleDragLeave);
      col.addEventListener("drop", handleDrop);

      const colTasks = tasks.filter(t => t.job_type === type);

      col.innerHTML = `
        <div class="column__head">
          <h2 class="column__title">${type}</h2>
        </div>
        <div class="cards">
          ${colTasks.map(task => renderCard(task)).join("")}
        </div>
      `;
      board.appendChild(col);
    });
  }

  function renderCard(data) {
    const colorMap = {
      "Électricité": "#f8b400",
      "Fibre": "#3fa9f5",
      "Cuivre": "#c08457",
      "PV / Solaire": "#ff8b3d",
      "GC / Viabilisation": "#8bc34a",
      "Autre": "#9e9e9e"
    };
    const bandColor = colorMap[data.job_type] || "#ccc";
    const fullName = `${data.prenom} ${data.nom}`;

    return `
      <div class="card" draggable="true"
        ondragstart="handleDragStart(event, ${data.id})"
        ondragend="handleDragEnd(event)">
        <div class="card__band" style="background:${bandColor}"></div>
        <div class="card__body">
          <div class="card__info">
            <div class="card__title">${fullName}</div>
            <div class="card__desc">${data.adresse || ''}</div>
          </div>
          <div class="menu">
            <button class="menu__btn" onclick="toggleMenu(event)">⋮</button>
            <div class="menu__list">
              <button class="menu__item" onclick="editTask(${data.id})">Modifier</button>
              <button class="menu__item" onclick="deleteTask(${data.id})">Supprimer</button>
              <button class="menu__item">Archiver</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // ----- Drag & Drop -----
  function handleDragStart(e, id) {
    draggedTaskId = id;
    e.dataTransfer.effectAllowed = "move";
    e.target.classList.add("is-dragging");
  }

  function handleDragEnd(e) {
    e.target.classList.remove("is-dragging");
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add("is-highlighted");
  }

  function handleDragLeave(e) {
    e.currentTarget.classList.remove("is-highlighted");
  }

  function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove("is-highlighted");
    const newType = e.currentTarget.dataset.type;
    const task = tasks.find(t => t.id === draggedTaskId);
    if (task && newType) {
      task.job_type = newType;
      renderBoard();
    }
  }

  // ----- Menu -----
  function toggleMenu(e) {
    const menu = e.target.nextElementSibling;
    menu.classList.toggle("is-open");
    document.addEventListener("click", (evt) => {
      if (!menu.contains(evt.target) && evt.target !== e.target)
        menu.classList.remove("is-open");
    }, { once: true });
  }

  // ----- Supprimer / Modifier -----
  function deleteTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    renderBoard();
  }

  function editTask(id) {
    const t = tasks.find(t => t.id === id);
    if (t) {
      form.nom.value = t.nom;
      form.prenom.value = t.prenom;
      form.adresse.value = t.adresse;
      form.date_rdv.value = t.date_rdv;
      form.job_type.value = t.job_type;
      deleteTask(id);
      openModal();
    }
  }

  renderBoard();
</script>
